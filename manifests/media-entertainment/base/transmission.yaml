---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-iscsi-transmission-config
  labels:
    app: transmission
spec:
  storageClassName: "freenas-iscsi-manual-csi"
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: xfs
    volumeHandle: pv-iscsi-transmission-config
    volumeAttributes:
      portal: 10.10.30.43:3260
      iqn: iqn.2005-10.org.freenas.ctl:transmission-config
      lun: "0"
      node_attach_driver: iscsi
      provisioner_driver: node-manual

---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-nfs-downloads
  labels:
    app: transmission
spec:
  storageClassName: "freenas-nfs-manual-csi"
  capacity:
    storage: 200Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  mountOptions:
    - nfsvers=4
    - nolock
    - noatime
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: nfs
    volumeHandle: pv-nfs-downloads
    volumeAttributes:
      server: 10.10.30.43
      share: /mnt/home-lab/containers/transmission
      node_attach_driver: nfs
      provisioner_driver: node-manual

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-nfs-downloads
  labels:
    app: transmission
spec:
  storageClassName: freenas-nfs-manual-csi
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 200Gi
  volumeName: pv-nfs-downloads

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-iscsi-transmission-config
  labels:
    app: transmission
spec:
  storageClassName: freenas-iscsi-manual-csi
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  volumeName: pv-iscsi-transmission-config

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: transmission-vpn-cred
  labels:
    app: transmission
spec:
  encryptedData:
    OPENVPN_PASSWORD: AgA91IwVr6IQFEPIFfOJ5p0cIfFPdymHdtKUvzSQps7Yrmh2zN6oA6XnMrkJ2sX7W6z/HNaxt3v8Lqc/Z72jxL9OKhqHJqJBDAR2zu7l0ngR+aTWMsG4pvYBS05HRM48FFkfI/GwLPP1KWj/YH82jBLZdHuzO0q1u5D32hEifc3hHj4nh34mqSywgFhk4O+3qepIqgCVFxFFKqr5KOD8VPxBt5ikZSJHTpeG7/AykQHsTXhQ8W8z3rQWTzVxhNCoWayh3vAKGwKE9DMiqNKYNRTvJEXzPJCD8xTBWQ3vtf8Tb59AWGb4NvnDFzJq9hAStigmismyYLg3VQ50hznPNZEW7nnJjfCPuXhoVCOOBMZQb0L3bahkCOvh4X/Dx/7jlDUDLKP60iP/4kU1WnJ/QURh2zrEpn1rfjS3wS3CuhuEXx57YtzGDsh22XB+YPHYN7vowDpjldToJwuiNf/SK4mEG3QFf7ghLjqnRdBMZHZrGj+ySQNhg3anQwwZTUJmZQp4MJDpG5knwNEyEIaBORgqolVqNsMMPFLk30QzfUdHMJmmVkhi4OFmt8TUv1NPwDaXTumQjSqOol96Cn9uKSddGEZ8x+Jg8QgFrkMnN5vJeQK1M5nol7kOs4RqRf+0icZ/Fn1t9xA62M30CJyy+ep7Ch2NpV1GSMiRYJZRWyJ6HuePgd/5dcDQIYtgyywRXskM/gweU0FzFaQC+scPq6Q5smkvSEND5Rg=
    OPENVPN_USERNAME: AgBGe2hvD4EG1y2tE2f5oraa61ZzLBgy3rxee2MBk6DrDa1hPXfOtelEq9B03PqBjKaoeyItW7RSIqPDYKr85HUzFQh8T7fVeiMzQSiSQF24DG17GE8fcWvvuKkJSa9PNCiXlG/14pDJxx3/6PZF1baon4pH0MuQu1kj3UDsyaqM18rRvLqITBt2UdreVQDCNC12c8j0ZElYlD2kkeoUQvdFp8wIXs/5v8uBkFzKckKVdM25grGIDdYTTngKkL0d6CmKFxcpBnnsPkGRsJHvMSXWtnbaP3ffcHzsVKpTxJyNTEE77xwalnAcaHMiE6zAVxPPT0NSJK4rJxXcJ47N8vJxl/6uz2lMo+zA70jiRi0jU4wJpzMbZIB6wFhqul5kAPWtgWAR1NCYOUR/eaLC8X92H0m7atCSi5Vd6zu1WhVuBUuPVUdcmw+mC4T6uj0OZ10t3zSjodrMxAtoAcSQOD7o2rPlUxgwNbHhQAZBe6kKRufpjNDeLp9OeyRjg6dVAA5QBAyPxZb6w6Do0VRAYhXYWeyFUxTml7V26XoDnQ5F4BjlohxJRnVj7NzPXjqMvlAnnaowbXfd3t8PeKWoQr4FoZkucaACtmX4hvptWy45eAFJW998UA4nlLnJoB3fPc6v99MF+I9Rwa7X7ajiv27EKMTJDyMgdBxlGsz6x1rIsC9pYt083DB/a5qjaNSZZprxNtMseDxkTIuB8gkBaM5w5Tm5hxAJLxI=
  template:
    metadata:
      name: transmission-vpn-cred
      labels:
        app: transmission
    type: Opaque

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: protonvpn-config
  labels:
    app: transmission
spec:
  encryptedData:
    sg-19.protonvpn.udp.ovpn: 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
  template:
    metadata:
      name: protonvpn-config
      labels:
        app: transmission
    type: Opaque

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: transmission-config
  labels:
    app: transmission
data:
  LOCAL_NETWORK: 10.10.30.0/24
  OPENVPN_OPTS: --inactive 3600 --ping 10 --ping-exit 60
  OPENVPN_PROVIDER: CUSTOM
  # OPENVPN_CONFIG: sg-19.protonvpn.udp
  # VPN_CONFIG_SOURCE: external
  # VPN_PROVIDER_HOME: /config/openvpn/custom
  TRANSMISSION_DOWNLOAD_DIR: /data/completed
  TRANSMISSION_INCOMPLETE_DIR: /data/incomplete
  TRANSMISSION_WATCH_DIR: /data/watch
  TRANSMISSION_DOWNLOAD_QUEUE_SIZE: "4"
  TZ: Asia/Singapore
  WEBPROXY_ENABLED: "false"
  CREATE_TUN_DEVICE: "true"
  HEALTH_CHECK_HOST: "google.com"
  PUID: "1000"
  PGID: "2000"

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: transmission
  labels:
    app: transmission
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  selector:
    matchLabels:
      app: transmission
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: transmission
    spec:
      initContainers:
        - name: copy-vpn-config
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Create directory structure
              mkdir -p /config/openvpn/custom/
              
              # Copy the config files to the writable location
              cp /etc/openvpn/secret/* /config/openvpn/custom/
              
              # Set permissions
              chmod 644 /config/openvpn/custom/*
              
              # Debug output
              echo "Files in /config/openvpn/custom/:"
              ls -la /config/openvpn/custom/
          volumeMounts:
            - mountPath: /etc/openvpn/secret/
              name: protonvpn-config
              readOnly: true
            - mountPath: /config
              name: transmission-config
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
        - name: prepare-custom-dir
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Copy from the writable config location to the custom dir
              cp /config/openvpn/custom/* /etc/openvpn/custom/
              chmod 644 /etc/openvpn/custom/*
              echo "Files in /etc/openvpn/custom/:"
              ls -la /etc/openvpn/custom/
          volumeMounts:
            - mountPath: /config
              name: transmission-config
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
      containers:
        - name: transmission
          image: "docker.io/haugene/transmission-openvpn:latest"
          imagePullPolicy: Always
          env:
            - name: OPENVPN_PROVIDER
              value: "CUSTOM"
            - name: OPENVPN_CONFIG
              value: "sg-19.protonvpn.udp"
            - name: VPN_CONFIG_SOURCE
              value: "/config/openvpn/custom"
          envFrom:
            - configMapRef:
                name: transmission-config
                optional: false
            - secretRef:
                name: transmission-vpn-cred
                optional: false
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 2
            successThreshold: 1
            tcpSocket:
              port: 9091
            timeoutSeconds: 2
          readinessProbe:
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 2
            successThreshold: 2
            tcpSocket:
              port: 9091
            timeoutSeconds: 2
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              add:
                - NET_ADMIN
            privileged: true
          volumeMounts:
            - mountPath: /data
              name: transmission-data
            - mountPath: /config
              name: transmission-config
            # Remove this line that mounts the empty directory to /etc/openvpn
            # - mountPath: /etc/openvpn
            #   name: openvpn-etc
            # Instead, mount just the custom directory
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
            requests:
              cpu: "200m"
              memory: "256Mi"
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      volumes:
        - name: transmission-data
          persistentVolumeClaim:
            claimName: pvc-nfs-downloads
        - name: transmission-config
          persistentVolumeClaim:
            claimName: pvc-iscsi-transmission-config
        - name: protonvpn-config
          secret:
            secretName: protonvpn-config
        # Replace the empty dir with a volume that points to our config directory
        - name: custom-config-dir
          emptyDir: {}
        # Remove this volume
        # - name: openvpn-etc
        #   emptyDir: {}

---
kind: Service
apiVersion: v1
metadata:
  name: transmission
  labels:
    app: transmission
spec:
  selector:
    app: transmission
  type: ClusterIP
  ports:
    - port: 9091
      protocol: TCP
      targetPort: 9091
  sessionAffinity: None

---
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: transmission
  labels:
    app: transmission
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/proxy-body-size: "128m"
spec:
  rules:
    - host: transmission.j3laserna.me
      http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: transmission
                port:
                  number: 9091
  tls:
    - hosts:
        - transmission.j3laserna.me
      secretName: wildcard-j3laserna-me-tls
