---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-iscsi-transmission-config
  labels:
    app: transmission
spec:
  storageClassName: "freenas-iscsi-manual-csi"
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: xfs
    volumeHandle: pv-iscsi-transmission-config
    volumeAttributes:
      portal: 10.10.30.43:3260
      iqn: iqn.2005-10.org.freenas.ctl:transmission-config
      lun: "0"
      node_attach_driver: iscsi
      provisioner_driver: node-manual

---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-nfs-downloads
  labels:
    app: transmission
spec:
  storageClassName: "freenas-nfs-manual-csi"
  capacity:
    storage: 200Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  mountOptions:
    - nfsvers=4
    - nolock
    - noatime
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: nfs
    volumeHandle: pv-nfs-downloads
    volumeAttributes:
      server: 10.10.30.43
      share: /mnt/home-lab/containers/transmission
      node_attach_driver: nfs
      provisioner_driver: node-manual

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-nfs-downloads
  labels:
    app: transmission
spec:
  storageClassName: freenas-nfs-manual-csi
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 200Gi
  volumeName: pv-nfs-downloads

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-iscsi-transmission-config
  labels:
    app: transmission
spec:
  storageClassName: freenas-iscsi-manual-csi
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  volumeName: pv-iscsi-transmission-config

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: transmission-vpn-cred
  labels:
    app: transmission
spec:
  encryptedData:
    OPENVPN_PASSWORD: AgA2aQR2XXvHfOEAUFDrh2S4YfXQXMnpB3j+y8CuSN1VjgYybj/KfP9D0zBODvvfHrHVajarWbV8ZncefYwusAL6Ane4X+i7PLPwf0UP+Wo3NHl4Fw6/yWu7m/P8xdxkvlqdyjgBmvC/WVw0l470BP+i+5hZDp7xvra+cGOJ2sYGTvh822LcQ1OQzBlbW2GbIGDkK+8fzDOCRlUue96tVHJzX/eY9bQXd6ZKzHogZHOGnoJTv85kTt1CdOE6f/8/TWpZvXIeaPiZiYdQ5ZkcNYEe0En6+zF5cpYPzpuQKAOwimxf3aWj9PgEURApwQ9XxfzxzBDCYbtDhQUKrkWeG3Ujv8laBglMVETpQrndmthHW0OZUGirLpmCLjGsWKPnXVRuS0nCzJsmUu1JfLAgphDn40c4ePw3Ag0/qnGt7f0Vqyzks/giNW3xZLKtqy3/yTHOdqMWUEkzMaDK5lH8mqg96RcIXr0llUgREg0IE+hOOyJNam4YoP69mJntX1/T1ztGakpT/89h0DjdBRjF9mje6UgHIiegNtszWkQG50ieg7N70CmWNjoJZ3uh7c6Qdt08hnTaRC3RP8mFQEoxW+1F8+LjjH9Aws81EP2psqzNTQOEtWDEzLCGYIijF+IQMOj3s0KpiqLaBnkKEpvHNz02rwzugd10WyGroMX05/Xwt1t/CAPBeRHfnt7V8VTm2uIn+lnnqoJkf6fU3+ppUsOMH8p1Mu615mQ=
    OPENVPN_USERNAME: AgBAZ7+co7r201OeAImkMM2VJgOOzoH/tfx+XBO0V9cKYJONYceqYFOe1AcY20Rr5v5mdUFzKgQsJi94vOQl84J0lt0lYyT/mMPsglyi2ijjEexlqt1iuAY9Vf/uXCYRJjIN44zaoRIIer9ugYuuo0HzTbJOD05syQTCFSpSQVmngr3QxHrmEogDRT+Va0k9hPKobtxrRDf37SESpBhmc2GTwLWGr7fUXT7dKwf69GDsxVNk6U4SXl7SezG3pRJYwWbbPJjD3Hj95Mf1ASBJ5g3FX8dd3NbCNFaQM4UZara1DbDy0AlEwGH+ZWncogj8mh1uj6hZDDqH+fteHOamYRpLQsEjksvdIyQIfBY7jZQWWofGjYpb3y/xIsA8OMB3UNxvTC2feUUzJB9hgIF1LKfjVnol1UIlexeRW3W6XAu8nQ9SL8QJWFvcbWRqK+zm3KIWrSKr49cwUHbJvZDKRjhLatgx1nufI1dzLbbIYkaPzNwj6gf0mJOUw+dKxS/vpqPsPGgz6FETJXMkmAGqQyTK8QdLjbuvDcnFy6sf3fcwEn+SkhK9l5v5pNRyHo94UuA6HJoqc3DdTNaRUTX1DqigJj4zOsNAE+V3JpVU/mt3xQ3+fXXVxvxKbXYesk1yK+jjBUC/stdCktQ0UUgR27qQo0E3mDRvmViWR3kSNz+RO8fHMvPynufzyWOfNA3YQxgZ0oT4ehUaUdJboQc1eJjEUvHxJOmub7A=
  template:
    metadata:
      name: transmission-vpn-cred
      labels:
        app: transmission
    type: Opaque

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: protonvpn-config
  labels:
    app: transmission
spec:
  encryptedData:
    sg-19.protonvpn.udp.ovpn: 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
  template:
    metadata:
      name: protonvpn-config
      labels:
        app: transmission
    type: Opaque

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: transmission-config
  labels:
    app: transmission
data:
  LOCAL_NETWORK: 10.10.30.0/24
  OPENVPN_OPTS: --inactive 3600 --ping 10 --ping-exit 60
  OPENVPN_PROVIDER: CUSTOM
  # OPENVPN_CONFIG: sg-19.protonvpn.udp
  # VPN_CONFIG_SOURCE: external
  # VPN_PROVIDER_HOME: /config/openvpn/custom
  TRANSMISSION_DOWNLOAD_DIR: /data/completed
  TRANSMISSION_INCOMPLETE_DIR: /data/incomplete
  TRANSMISSION_WATCH_DIR: /data/watch
  TRANSMISSION_DOWNLOAD_QUEUE_SIZE: "4"
  TZ: Asia/Singapore
  WEBPROXY_ENABLED: "false"
  CREATE_TUN_DEVICE: "true"
  HEALTH_CHECK_HOST: "google.com"
  PUID: "1000"
  PGID: "2000"

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: transmission
  labels:
    app: transmission
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  selector:
    matchLabels:
      app: transmission
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: transmission
    spec:
      initContainers:
        - name: copy-vpn-config
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Create directory structure
              mkdir -p /config/openvpn/custom/
              
              # Copy the config files to the writable location
              cp /etc/openvpn/secret/* /config/openvpn/custom/
              
              # Set permissions
              chmod 644 /config/openvpn/custom/*
              
              # Debug output
              echo "Files in /config/openvpn/custom/:"
              ls -la /config/openvpn/custom/
          volumeMounts:
            - mountPath: /etc/openvpn/secret/
              name: protonvpn-config
              readOnly: true
            - mountPath: /config
              name: transmission-config
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
        - name: prepare-custom-dir
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Copy from the writable config location to the custom dir
              cp /config/openvpn/custom/* /etc/openvpn/custom/
              chmod 644 /etc/openvpn/custom/*
              echo "Files in /etc/openvpn/custom/:"
              ls -la /etc/openvpn/custom/
          volumeMounts:
            - mountPath: /config
              name: transmission-config
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
      containers:
        - name: transmission
          image: "docker.io/haugene/transmission-openvpn:latest"
          imagePullPolicy: Always
          env:
            - name: OPENVPN_PROVIDER
              value: "CUSTOM"
            - name: OPENVPN_CONFIG
              value: "sg-19.protonvpn.udp"
            - name: VPN_CONFIG_SOURCE
              value: "/config/openvpn/custom"
          envFrom:
            - configMapRef:
                name: transmission-config
                optional: false
            - secretRef:
                name: transmission-vpn-cred
                optional: false
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 2
            successThreshold: 1
            tcpSocket:
              port: 9091
            timeoutSeconds: 2
          readinessProbe:
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 2
            successThreshold: 2
            tcpSocket:
              port: 9091
            timeoutSeconds: 2
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              add:
                - NET_ADMIN
            privileged: true
          volumeMounts:
            - mountPath: /data
              name: transmission-data
            - mountPath: /config
              name: transmission-config
            # Remove this line that mounts the empty directory to /etc/openvpn
            # - mountPath: /etc/openvpn
            #   name: openvpn-etc
            # Instead, mount just the custom directory
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
            requests:
              cpu: "200m"
              memory: "256Mi"
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      volumes:
        - name: transmission-data
          persistentVolumeClaim:
            claimName: pvc-nfs-downloads
        - name: transmission-config
          persistentVolumeClaim:
            claimName: pvc-iscsi-transmission-config
        - name: protonvpn-config
          secret:
            secretName: protonvpn-config
        # Replace the empty dir with a volume that points to our config directory
        - name: custom-config-dir
          emptyDir: {}
        # Remove this volume
        # - name: openvpn-etc
        #   emptyDir: {}

---
kind: Service
apiVersion: v1
metadata:
  name: transmission
  labels:
    app: transmission
spec:
  selector:
    app: transmission
  type: ClusterIP
  ports:
    - port: 9091
      protocol: TCP
      targetPort: 9091
  sessionAffinity: None

---
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: transmission
  labels:
    app: transmission
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/proxy-body-size: "128m"
spec:
  rules:
    - host: transmission.j3laserna.me
      http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: transmission
                port:
                  number: 9091
  tls:
    - hosts:
        - transmission.j3laserna.me
      secretName: wildcard-j3laserna-me-tls
