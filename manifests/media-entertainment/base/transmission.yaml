---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-iscsi-transmission-config
  labels:
    app: transmission
spec:
  storageClassName: "freenas-iscsi-manual-csi"
  capacity:
    storage: 5Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: xfs
    volumeHandle: pv-iscsi-transmission-config
    volumeAttributes:
      portal: 192.168.18.96:3260
      iqn: iqn.2005-10.org.freenas.ctl:transmission-config
      lun: "0"
      node_attach_driver: iscsi
      provisioner_driver: node-manual

---
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-nfs-downloads
  labels:
    app: transmission
spec:
  storageClassName: "freenas-nfs-manual-csi"
  capacity:
    storage: 200Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  mountOptions:
    - nfsvers=4
    - nolock
    - noatime
  csi:
    driver: org.democratic-csi.node-manual
    readOnly: false
    fsType: nfs
    volumeHandle: pv-nfs-downloads
    volumeAttributes:
      server: 192.168.18.96
      share: /mnt/home-lab/media/transmission
      node_attach_driver: nfs
      provisioner_driver: node-manual

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-nfs-downloads
  namespace: media
  labels:
    app: transmission
spec:
  storageClassName: freenas-nfs-manual-csi
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 200Gi
  volumeName: pv-nfs-downloads

---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-iscsi-transmission-config
  namespace: media
  labels:
    app: transmission
spec:
  storageClassName: freenas-iscsi-manual-csi
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  volumeName: pv-iscsi-transmission-config

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: transmission-vpn-cred
  namespace: media
  labels:
    app: transmission
spec:
  encryptedData:
    OPENVPN_PASSWORD: AgAd3XCoNo+39UEFIE4kT435BfqtTcgKOdT27CK1HASld4M+VSs8qt99VBKB0jpuBu1hT1qOdXufswEn4+PlwtlWCX5oVA714PNBxURtLV/WnSOS+F//EeR7Nmu5/uvTLVuuB4JlYM1sWdNqOzfde4ZIdufodpKW6YPC0qU4813XoBDUofZ8QFaBYKa5tqxGpVuBDFTKho3yLLiyFbfsNmBr3t0+IhwB0Gjq39uh+FBWZrmP3upIeE496xf+fkpboIFXhjRi5E2DMIELSVIooSVz95dKCMsp2hA/22miAUBKtF/AmdWUODzyAhJqRLY+llivIuh2QHz2+x3hvrYU+hEk+07dMtfJC8KR/gdYVxGfjySLKWNS4UmXWdskKxKDJl1aR7xFQPFKQt38ZOWzM5FOgOq4489ZYH4yugrZqBzM0dbwCBnxTMH3TqAPFtFUSMNFQqVjL+jB909+9jwGzsLTU1jMTcJHrz2ED+yse6qfJP86rUpa0ds+3UsmOxl8Gjj5ZGbJkqf/nWIOeAyvq3tVUEqdCwN/lTKk4igAVow5lEO6vca+mPOyLVQBVya46SaDC7ayr1UCbYP4jwpbEXljcF4mJLLFGjfygseE4al8kOUr23Uyf0TcanNTa6GiC3DUmpbe1dG2R+D3xTIEPGyKtW9m1631kK8yEz8kzkaAGlHrVfWAbtH1ku9yshxSJc8Fd/dpZJtqMEgTeHiQcZOxfNRzCB2tXAw=
    OPENVPN_USERNAME: AgARI91xklhup9Ytf7zyFbWtLz5rdqXW42EpWRKjfngjVTjrYoCMwxcbATL2SSUGCQjT9Xl0GJrUznLlIEIbWgUpIqxQcRrIdyvF3ZvHbapZi3PHwbcoNYgKAr8xipDE5hMFBB6vimZtkTXCpbuHya9aGhEBJRANSQcEsgL00HolX8+RxMyepag5QgA4c5y+HDYmgogw2swr2iwbPVclw5XEk0V+6bJ6eW1QJsB3zuYHKaM9XuqbarOXhvda8X/5u1Q1nOKVSJ9q0ufcpl1S7IUgd1LG+pLRO4vDSdkqbLVA0QbW5D1/O0CtzTbnDvenwSYqXECNxoJL3kuy/FPyQgFaWcJDkordPwlJc+iTZzhhS5JD4s+YXH2s1gHgtDJ9tAaBPm2ToZEg8GAXAYI401BpmW3Lc3FLjgSxKItMSpmAs4+EGSi1GdzibQPOShWjrst5IgRLNFZQl/iQyYIss/eZ0/dMLH0mp/aIi9L/JZhHiGrsJU1KiWG3U6x1PWR2yH1R/OMROFHaEF64Z4ewyBP4JHkE9dTwbPD4pVXU38Mbvx7px4wscVrTKuSfQE7yyJt/gqY3vsdbifw/w8m4Ac66H1C7FDGfjkpCIYa1pXdOWOfWkp+tjZ5+xs63bbjWJAy54hWNyrjqhO0T6o3+xrFcgRA1rOB1w69vw10+SGtJ1gMaENQ5rJrhqJzhoEAHan5kiVNBQva7MRgHEMJs2LptWxuPO1Z9HvI=
  template:
    metadata:
      name: transmission-vpn-cred
      labels:
        app: transmission
    type: Opaque

---
kind: SealedSecret
apiVersion: bitnami.com/v1alpha1
metadata:
  name: protonvpn-config
  labels:
    app: transmission
  namespace: media
spec:
  encryptedData:
    sg-19.protonvpn.udp.ovpn: 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
  template:
    metadata:
      name: protonvpn-config
      labels:
        app: transmission
    type: Opaque

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: transmission-config
  namespace: media
  labels:
    app: transmission
data:
  LOCAL_NETWORK: 192.168.18.0/24
  OPENVPN_OPTS: --inactive 3600 --ping 10 --ping-exit 60
  OPENVPN_PROVIDER: CUSTOM
  # OPENVPN_CONFIG: sg-19.protonvpn.udp
  # VPN_CONFIG_SOURCE: external
  # VPN_PROVIDER_HOME: /config/openvpn/custom
  TRANSMISSION_DOWNLOAD_DIR: /data/completed
  TRANSMISSION_INCOMPLETE_DIR: /data/incomplete
  TRANSMISSION_WATCH_DIR: /data/watch
  TRANSMISSION_DOWNLOAD_QUEUE_SIZE: "4"
  TZ: Asia/Singapore
  WEBPROXY_ENABLED: "false"
  CREATE_TUN_DEVICE: "true"
  HEALTH_CHECK_HOST: "google.com"
  PUID: "1000"
  PGID: "2000"

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: transmission
  namespace: media
  labels:
    app: transmission
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  selector:
    matchLabels:
      app: transmission
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: transmission
    spec:
      initContainers:
        - name: copy-vpn-config
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Create directory structure
              mkdir -p /config/openvpn/custom/
              
              # Copy the config files to the writable location
              cp /etc/openvpn/secret/* /config/openvpn/custom/
              
              # Set permissions
              chmod 644 /config/openvpn/custom/*
              
              # Debug output
              echo "Files in /config/openvpn/custom/:"
              ls -la /config/openvpn/custom/
          volumeMounts:
            - mountPath: /etc/openvpn/secret/
              name: protonvpn-config
              readOnly: true
            - mountPath: /config
              name: transmission-config
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
        - name: prepare-custom-dir
          image: busybox:latest
          command:
            - sh
            - -c
            - |
              # Copy from the writable config location to the custom dir
              cp /config/openvpn/custom/* /etc/openvpn/custom/
              chmod 644 /etc/openvpn/custom/*
              echo "Files in /etc/openvpn/custom/:"
              ls -la /etc/openvpn/custom/
          volumeMounts:
            - mountPath: /config
              name: transmission-config
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
      containers:
        - name: transmission
          image: "docker.io/haugene/transmission-openvpn:latest"
          imagePullPolicy: Always
          env:
            - name: OPENVPN_PROVIDER
              value: "CUSTOM"
            - name: OPENVPN_CONFIG
              value: "sg-19.protonvpn.udp"
            - name: VPN_CONFIG_SOURCE
              value: "/config/openvpn/custom"
          envFrom:
            - configMapRef:
                name: transmission-config
                optional: false
            - secretRef:
                name: transmission-vpn-cred
                optional: false
          livenessProbe:
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 2
            successThreshold: 1
            tcpSocket:
              port: 9091
            timeoutSeconds: 2
          readinessProbe:
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 2
            successThreshold: 2
            tcpSocket:
              port: 9091
            timeoutSeconds: 2
          securityContext:
            allowPrivilegeEscalation: true
            capabilities:
              add:
                - NET_ADMIN
            privileged: true
          volumeMounts:
            - mountPath: /data
              name: transmission-data
            - mountPath: /config
              name: transmission-config
            # Remove this line that mounts the empty directory to /etc/openvpn
            # - mountPath: /etc/openvpn
            #   name: openvpn-etc
            # Instead, mount just the custom directory
            - mountPath: /etc/openvpn/custom
              name: custom-config-dir
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
            requests:
              cpu: "200m"
              memory: "256Mi"
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
      volumes:
        - name: transmission-data
          persistentVolumeClaim:
            claimName: pvc-nfs-downloads
        - name: transmission-config
          persistentVolumeClaim:
            claimName: pvc-iscsi-transmission-config
        - name: protonvpn-config
          secret:
            secretName: protonvpn-config
        # Replace the empty dir with a volume that points to our config directory
        - name: custom-config-dir
          emptyDir: {}
        # Remove this volume
        # - name: openvpn-etc
        #   emptyDir: {}

---
kind: Service
apiVersion: v1
metadata:
  name: transmission
  namespace: media
  labels:
    app: transmission
spec:
  selector:
    app: transmission
  type: ClusterIP
  ports:
    - port: 9091
      protocol: TCP
      targetPort: 9091
  sessionAffinity: None

---
kind: Ingress
apiVersion: networking.k8s.io/v1
metadata:
  name: transmission
  namespace: media
  labels:
    app: transmission
spec:
  rules:
    - host: transmission.j3laserna.me
      http:
        paths:
          - path: "/"
            pathType: Prefix
            backend:
              service:
                name: transmission
                port:
                  number: 9091
  tls:
    - hosts:
        - transmission.j3laserna.me
      secretName: wildcard-j3laserna-me-tls
